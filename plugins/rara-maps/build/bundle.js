/*! Built from commit: 03a6df8690603defa0f14484318587028039bc36 */var t={d:(e,a)=>{for(var i in a)t.o(a,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:a[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{boundaryRadiusCreateMap:()=>v,heritageTrailCreateMap:()=>x,historyCreateMap:()=>A,vectorCreateMap:()=>D});class a{#t;constructor(t,e){this.#t=e,t.on("load",()=>{t.addSource("empty",{type:"geojson",data:{type:"FeatureCollection",features:[]}});for(let e=this.#t.length-1;e>=0;e--)t.addLayer({id:`z-${e}`,type:"symbol",source:"empty"},e===this.#t.length-1?void 0:`z-${e+1}`)})}getPosition(t){if(!this.#t.includes(t))throw new Error(`Layer ${t} not included as a sortable layer`);return`z-${this.#t.indexOf(t)}`}}class i{#e;#a;#i;#o;constructor(t,e,a,i){console.debug(`Layer.create id=${e} visible=${a}`),this.#e=e,this.#a=t,this.#i=a,this.#o=i}set visible(t){console.debug(`Layer.setVisible id=${this.#e} visible=${t}`),this.#i=t,this.#s()}get visible(){return this.#i}onLoaded(){console.debug(`Layer.onLoaded id=${this.#e} visible=${this.visible} callback=${this.#o}`),this.#s(),this.#o&&this.#o(this.#e)}toggleVisible(){return console.debug(`Layer.toggleVisible id=${this.#e} visible=${this.visible}`),this.visible="visible"!==this.#a.map.getLayoutProperty(this.#e,"visibility"),this.visible}#s(){console.debug(`Layer.onVisibleChange id=${this.#e} visible=${this.visible}`),this.#a.map.setLayoutProperty(this.#e,"visibility",this.visible?"visible":"none")}}class o{#r;#n;#l;#c;constructor(t){this.#r={},this.#n=t.map,this.#l=t.menu,this.#c=new a(t.map,t.zOrder)}get map(){return this.#n}getLayer(t){return this.#r[t]}get zOrder(){return this.#c}addLayer(t,e){e.visible=e.visible??!0;const a=this.#d(e.id,e.visible,e.callback);e.callback=t=>{a.onLoaded(t)},e.zOrder=this.#c,t(this.#n,e);(e.addToMenu??!0)&&this.#l.addItem({id:e.id,text:e.text,onclick:()=>a.toggleVisible(),active:e.visible,color:e.color})}#d(t,e,a){const o=new i(this,t,e,a);return this.#r[t]=o,o}}class s{#p;constructor(){if(this.#p=document.getElementById("menu"),this.#p){const t=t=>{"m"===t.key&&this.#u()};document.addEventListener("keydown",t,!0)}}addItem(t){if(this.#p){const e=document.createElement("a");e.id=`menu_${t.id}`,e.layerId=t.id,e.href="#",e.textContent=t.text,e.className=t.active?"active":"",e.onclick=a=>{a.preventDefault(),a.stopPropagation(),e.className=t.onclick()?"active":""};const a=document.createElement("div");a.className="box",a.style.backgroundColor=t.color??"transparent",e.appendChild(a),this.#p.appendChild(e),this.#h()}}#h(){this.#p.hidden=!1}#u(){console.debug("Menu.toggleVisible"),this.#p.hidden=!this.#p.hidden}}class r{#e;#y;#a;#b;#m;constructor(t,e){console.debug(`Location.create id=${e}`),this.#e=e,this.#y=null,this.#a=t,this.#b=null,this.#m=!1}get data(){return this.#y}get popupVisible(){return this.#m}set popupVisible(t){console.debug(`Location.setPopupVisible id=${this.#e} visible=${t}`),this.#m=t,this.#g()}setData(t){console.debug(`Location.setData id=${this.#e} data=${t}`),this.#y=t,this.#b=new maplibregl.Popup({closeButton:!1,closeOnClick:!1}),this.#b.setLngLat(t.geometry.coordinates).setHTML(t.properties.title).addTo(this.#a.map),this.#g()}#g(){console.debug(`Location.onPopupVisibleChange id=${this.#e} visible=${this.popupVisible} popup=${this.#b}`),this.#b&&(this.#b.getElement().style.visibility=this.popupVisible?"visible":"hidden")}}class n{#v;#n;constructor(t){this.#v={},this.#n=t.map}get map(){return this.#n}getLocation(t){return t in this.#v||this.#f(t),this.#v[t]}#f(t){console.debug("LocationManager.addLocation",t);const e=new r(this,t);return this.#v[t]=e,e}}function l(t){console.debug("Map",t);const e=new maplibregl.Map(t.config),a=new s,i=new o({map:e,menu:a,zOrder:t.zOrder??[]}),r=new n({map:e});return e.appData={layers:i,locations:r},function(t){t.addControl(new maplibregl.NavigationControl({visualizePitch:!0,visualizeRoll:!0,showZoom:!0,showCompass:!0})),t.addControl(new maplibregl.FullscreenControl),t.addControl(new maplibregl.ScaleControl,"bottom-right")}(e),e}function c(t,e){const a=e.id;t.on("load",()=>{const i=t.getStyle().layers;let o;for(let t=0;t<i.length;t++)if("symbol"===i[t].type&&"layout"in i[t]&&i[t].layout["text-field"]){o=i[t].id;break}t.addSource(a,{url:"https://tiles.openfreemap.org/planet",type:"vector"}),t.addLayer({id:a,source:a,"source-layer":"building",type:"fill-extrusion",minzoom:15,filter:["!=",["get","hide_3d"],!0],layout:{visibility:e.visible?"visible":"none"},paint:{"fill-extrusion-color":["interpolate",["linear"],["get","render_height"],0,"lightgray",200,"royalblue",400,"lightblue"],"fill-extrusion-height":["interpolate",["linear"],["zoom"],15,0,16,["get","render_height"]],"fill-extrusion-base":["case",[">=",["get","zoom"],16],["get","render_min_height"],0]}},o),e.callback&&e.callback(["buildings",a])})}function d(t,e){const a=e.id;t.on("load",()=>{fetch(e.url).then(t=>t.json()).then(i=>{t.addSource(a,{type:"geojson",data:i}),t.addLayer({id:a,type:"line",source:a,layout:{"line-join":"round","line-cap":"round",visibility:e.visible?"visible":"none"},paint:{"line-color":e.color,"line-width":6}},e.zOrder?e.zOrder.getPosition(a):null),e.callback&&e.callback(["line",a])})})}const p="%{RARA_MAPS}";function u(t){return t.startsWith(p)?raraMapsData.baseUrl+t.slice(p.length):t}function h(t,e){t.on("load",async()=>{const a=e.id,i=t.appData.locations,o=await t.loadImage(u(`%{RARA_MAPS}/assets/icons/pin-${e.color}.png`));t.addImage(a,o.data),fetch(e.url).then(t=>t.json()).then(o=>{if(e.tags&&(o.features=o.features.filter(t=>e.tags.every(e=>t.properties.tags.includes(e)))),o.features.forEach(t=>{const a=i.getLocation(t.properties.id);a.setData(t),e.staticPopups&&(a.popupVisible=!0)}),t.addSource(a,{type:"geojson",data:o}),t.addLayer({id:a,type:"symbol",source:a,layout:{"icon-image":a,"icon-size":1,"icon-allow-overlap":!0,visibility:e.visible?"visible":"none"}},e.zOrder?e.zOrder.getPosition(a):null),!e.staticPopups){let o,s;t.on("mousemove",a,a=>{const r=a.features[0].geometry.coordinates.toString();if(s!==r){s=r,t.getCanvas().style.cursor="pointer";const n=a.features[0].geometry.coordinates.slice();for(;Math.abs(a.lngLat.lng-n[0])>180;)n[0]+=a.lngLat.lng>n[0]?360:-360;o&&(i.getLocation(o).popupVisible=!1),o=a.features[0].properties.id,i.getLocation(o).popupVisible=!0,e.onenter&&e.onenter(o)}}),t.on("mouseleave",a,()=>{const t=o;e.onleave&&e.onleave(t)})}e.onclick&&t.on("click",a,t=>{e.onclick(t.features[0].properties.id)})})})}const y=[];let b=null;const m="bottom-left";function g(t,e){const a=e.id;t.on("load",()=>{fetch(u("%{RARA_MAPS}/assets/data/overlays.json")).then(t=>t.json()).then(i=>{const o=i.overlays.features.find(t=>t.properties.id===a);if(t.addSource(a,{type:"image",url:u(o.properties.url),coordinates:o.geometry.coordinates}),t.addLayer({id:a,type:"raster",source:a,paint:{"raster-opacity":e.opacity??1},layout:{visibility:e.visible?"visible":"none"}},e.zOrder?e.zOrder.getPosition(a):null),o.properties.attribution){const e=i.attributions[o.properties.attribution];e&&function(t,e){y.includes(e)||y.push(e),b&&t.removeControl(b),b=new maplibregl.AttributionControl({compact:!0,customAttribution:`<br>${y.join("<br>")}`}),t.addControl(b,m);const a=document.getElementsByClassName(`maplibregl-ctrl-${m}`)[0].getElementsByTagName("details")[0];a.classList.remove("maplibregl-compact-show"),a.removeAttribute("open")}(t,e)}e.callback&&e.callback(["overlay",a])})})}function v(){const t=new l({config:{style:u("%{RARA_MAPS}/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},zOrder:["camantsoc_1836_1838","camantsoc_1910","camantsoc_1925","barnwell_priory","boundary","heritage_trail","attractions","improvements"]});let e=null;let a=null;const i=new maplibregl.LngLat(.14547600132800653,52.212610097321885),o=turf.point([i.lng,i.lat]),s=()=>{e=e||Date.now();const r=(Date.now()-e)%3e4,n=turf.along(a,turf.lineDistance(a)*r/3e4).geometry.coordinates,l=turf.distance(o,n,{units:"meters"}),c=turf.bearing(o,n),d=l+500,p=turf.destination(o,d,c,{units:"meters"}).geometry.coordinates;t.jumpTo(t.calculateCameraOptionsFromTo(new maplibregl.LngLat(p[0],p[1]),300,i)),requestAnimationFrame(s)};return t.on("load",async()=>{fetch(u("%{RARA_MAPS}/assets/data/line_boundary_smooth.json")).then(t=>t.json()).then(t=>{const e=t.features[0].geometry.coordinates;a=turf.lineString(e),s()})}),t.appData.layers.addLayer(c,{id:"3d_buildings",text:"3D buildings",color:"#aaaaaa",visible:!0}),t.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/assets/data/line_boundary.json"),color:"black",visible:!0}),t.appData.layers.addLayer(d,{id:"heritage_trail",text:"Heritage trail line",url:u("%{RARA_MAPS}/assets/data/line_heritage_trail.json"),color:"green",visible:!1}),t.appData.layers.addLayer(h,{id:"attractions",text:"Attractions",url:u("%{RARA_MAPS}/assets/data/locations.json"),tags:["attractions"],color:"yellow",visible:!0,staticPopups:!0}),t.appData.layers.addLayer(h,{id:"improvements",text:"Improvements",url:u("%{RARA_MAPS}/assets/data/locations.json"),tags:["improvements"],color:"red",visible:!0,staticPopups:!0}),t.appData.layers.addLayer(g,{id:"barnwell_priory",text:"Barnwell Priory (historical)",color:"orange",visible:!1}),t.appData.layers.addLayer(g,{id:"camantsoc_1836_1838",text:"Map circa 1836-1838",opacity:1,visible:!1}),t.appData.layers.addLayer(g,{id:"camantsoc_1910",text:"Map circa 1910",opacity:1,visible:!1}),t.appData.layers.addLayer(g,{id:"camantsoc_1925",text:"Map circa 1925",opacity:1,visible:!1}),t}class f{#L;#_;#x;#A;#D;#S;#C;#M;#o;constructor(t){this.#L=document.querySelectorAll(".commentary"),this.#L.forEach(t=>t.style="display: none;"),this.#_=Array.from(this.#L).map(t=>t.id),this.#x=0,this.#A=this.#_[this.#x],this.#D=document.querySelectorAll(".prev-button"),this.#S=document.querySelectorAll(".prev-label"),this.#C=document.querySelectorAll(".next-button"),this.#M=document.querySelectorAll(".next-label"),this.#D.forEach(t=>t.addEventListener("click",({})=>this.#P())),this.#C.forEach(t=>t.addEventListener("click",({})=>this.#w())),this.#o=t.callback}get ids(){return this.#_}setIndex(t){const e=this.#A;this.#x=t,this.#A=this.#_[this.#x],console.debug(`Commentary.setIndex ${e} -> ${t} ${this.#A}`);document.querySelector("#"+e).style.display="none";document.querySelector("#"+this.#A).style.display="block",this.#x>0?(this.#D.forEach(t=>t.style.visibility="visible"),this.#S.forEach(t=>t.textContent=document.querySelector("#"+this.#_[this.#x-1]).querySelector("h1").textContent)):this.#D.forEach(t=>t.style.visibility="hidden"),this.#x+1<this.#_.length?(this.#C.forEach(t=>t.style.visibility="visible"),this.#M.forEach(t=>t.textContent=document.querySelector("#"+this.#_[this.#x+1]).querySelector("h1").textContent)):this.#C.forEach(t=>t.style.visibility="hidden"),this.#o&&this.#o(e,this.#A)}#P(){this.setIndex((this.#x-1+this.#_.length)%this.#_.length)}#w(){this.setIndex((this.#x+1)%this.#_.length)}}class L{#k;#R;#n;#$;#I;#O;#j;#z;#V;#E;#T;#B;#q;#F;constructor(t){this.#k={coord:null,altitude:t.altitude??500,distance:null},this.#R=t.distance??500,this.#n=t.map,this.#q=1e-4,this.#N(t.lineId,t.autoStart??!1)}#N(t,e){this.#n.getSource(t).getData().then(t=>{console.debug("Route loaded");const a=t.features[0].geometry.coordinates;this.#$=turf.lineString(a);const i=maplibregl.MercatorCoordinate.fromLngLat(a[0]),o=maplibregl.MercatorCoordinate.fromLngLat(turf.along(this.#$,turf.lineDistance(this.#$)/4).geometry.coordinates),s=o.x-i.x,r=o.y-i.y;this.#k.distance=this.#R??Math.hypot(s,r),this.#k.coord=new maplibregl.MercatorCoordinate(i.x-s,i.y-r),this.#n.jumpTo(this.#n.calculateCameraOptionsFromTo(this.#k.coord.toLngLat(),this.#k.altitude,a[0])),e&&(console.debug("Automatically starting"),this.#H())})}#H(){if(console.debug("Route.start"),this.#z=0,this.#T=null,this.#B=!1,this.#F=1,this.#O){console.debug("Start coordinates:",this.#O);const t=turf.point(this.#O),e=turf.nearestPointOnLine(this.#$,t);this.#z=e.properties.location,console.debug("Start distance (km):",this.#z)}if(this.#V){console.debug("Stop coordinates:",this.#V);const t=turf.point(this.#V),e=turf.nearestPointOnLine(this.#$,t);this.#T=e.properties.location,console.debug("Stop distance (km):",this.#T)}this.#T&&this.#T<this.#z&&(this.#F=-1),this.#I=Date.now(),this.#U()}#U(){if(this.#B)return;const t=Date.now()-this.#I;let e=this.#z+t*this.#q*this.#F;if(!this.#T){e%=turf.lineDistance(this.#$)}const a=turf.along(this.#$,e).geometry.coordinates;this.#n.getSource("point").setData({type:"Point",coordinates:a});const i=maplibregl.MercatorCoordinate.fromLngLat(a),o=i.x-this.#k.coord.x,s=i.y-this.#k.coord.y,r=Math.hypot(o,s)-this.#k.distance;if(r>0){const t=Math.atan2(s,o);this.#k.coord.x+=Math.cos(t)*r,this.#k.coord.y+=Math.sin(t)*r}if(this.#n.jumpTo(this.#n.calculateCameraOptionsFromTo(this.#k.coord.toLngLat(),this.#k.altitude,a)),null!==this.#T&&(this.#F>0&&e>=this.#T||this.#F<0&&e<=this.#T))return this.#B=!0,void console.debug("Stopped at distance:",this.#T);requestAnimationFrame(()=>{this.#U()})}fly(t,e){console.debug("Fly from",t,"to",e),this.#O=t,this.#V=e,this.#B=!1,this.#$&&this.#H()}}let _=null;function x(t){t=t??{};const e=new l({config:{style:u("%{RARA_MAPS}/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},zOrder:["boundary","heritage_trail","locations","point"]}),a=e.appData.locations;e.on("load",()=>{e.addSource("point",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"Point",coordinates:[0,0]}}}),e.addLayer({id:"point",source:"point",type:"circle",paint:{"circle-radius":10,"circle-color":"#ff0000","circle-stroke-width":2,"circle-stroke-color":"white"}},e.appData.layers.zOrder.getPosition("point"))}),e.appData.layers.addLayer(c,{id:"3d_buildings",text:"3D buildings",color:"#aaaaaa",visible:!0}),e.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/assets/data/line_boundary.json"),color:"black",visible:!1}),e.appData.layers.addLayer(d,{id:"heritage_trail",text:"Heritage trail line",url:u("%{RARA_MAPS}/assets/data/line_heritage_trail.json"),color:"green",callback:({})=>{_=new L({altitude:200,distance:500,lineId:"heritage_trail",map:e})},visible:!0}),e.appData.layers.addLayer(h,{id:"locations",text:"Heritage trail locations",url:u("%{RARA_MAPS}/assets/data/locations.json"),tags:["attractions"],color:"green",onclick:t.locationOnClick??null,visible:!0});return new f({callback(t,e){let i=[t];const o=document.getElementById(t).getAttribute("additionalLocations");o&&(i=i.concat(o.split(" ")));let s=[e];const r=document.getElementById(e).getAttribute("additionalLocations");r&&(s=s.concat(r.split(" "))),console.debug(`hideIds = ${i}`);for(const t of i)a.getLocation(t).popupVisible=!1;console.debug(`showIds = ${s}`);for(const t of s)a.getLocation(t).popupVisible=!0;!function(t,e){if(console.debug(`Fly from ${t} to ${e}`),t!==e){const i=a.getLocation(t).data.geometry.coordinates,o=a.getLocation(e).data.geometry.coordinates;console.debug(`Fly from ${t} ${i} to ${e} ${o}`),_&&_.fly(i,o,2e3)}}(t,e)}}).setIndex(0),e}function A(){const t=new l({config:{style:u("%{RARA_MAPS}/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},zOrder:["camantsoc_1836_1838","camantsoc_1910","camantsoc_1925","boundary"]});return t.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/assets/data/line_boundary.json"),color:"black",visible:!0}),t.appData.layers.addLayer(g,{id:"camantsoc_1836_1838",text:"Map circa 1836-1838",opacity:1,visible:!1,addToMenu:!1}),t.appData.layers.addLayer(g,{id:"camantsoc_1910",text:"Map circa 1910",opacity:1,visible:!1,addToMenu:!1}),t.appData.layers.addLayer(g,{id:"camantsoc_1925",text:"Map circa 1925",opacity:1,visible:!1,addToMenu:!1}),function(t){const e={c_1836_1838:"camantsoc_1836_1838",c_1910:"camantsoc_1910",c_1925:"camantsoc_1925"},a=new f({callback(a,i){console.debug(`history.onUpdate id ${a} -> ${i}`);const o=e[a],s=e[i];console.debug(`history.onUpdate layer ${o} -> ${s}`),t.appData.layers.getLayer(o).visible=!1,t.appData.layers.getLayer(s).visible=!0}});function i(o){const s=e[a.ids[0]];o.isSourceLoaded&&o.sourceId===s&&(console.debug(`Source ${o.sourceId} is loaded`),a.setIndex(0),t.off("sourcedata",i))}t.on("sourcedata",i)}(t),t}function D(t){t=t??{overlay_opacity:1};const e=new l({config:{style:u("%{RARA_MAPS}/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},zOrder:["camantsoc_1836_1838","camantsoc_1910","camantsoc_1925","barnwell_priory","boundary","heritage_trail","attractions","improvements"]});return t.layers&&!t.layers.includes("3d_buildings")||e.appData.layers.addLayer(c,{id:"3d_buildings",text:"3D buildings",color:"#aaaaaa",visible:!1}),t.layers&&!t.layers.includes("boundary")||e.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/assets/data/line_boundary.json"),color:"black",visible:!0}),t.layers&&!t.layers.includes("heritage_trail")||e.appData.layers.addLayer(d,{id:"heritage_trail",text:"Heritage trail line",url:u("%{RARA_MAPS}/assets/data/line_heritage_trail.json"),color:"green",visible:!1}),t.layers&&!t.layers.includes("attractions")||e.appData.layers.addLayer(h,{id:"attractions",text:"Attractions",url:u("%{RARA_MAPS}/assets/data/locations.json"),tags:["attractions"],color:"yellow",onclick:t.locationOnClick??null,onenter:t.locationOnEnter??null,onleave:t.locationOnLeave??null,visible:t.locationVisible??!1}),t.layers&&!t.layers.includes("improvements")||e.appData.layers.addLayer(h,{id:"improvements",text:"Improvements",url:u("%{RARA_MAPS}/assets/data/locations.json"),tags:["improvements"],color:"red",onclick:t.locationOnClick??null,onenter:t.locationOnEnter??null,onleave:t.locationOnLeave??null,visible:t.locationVisible??!1}),t.layers&&!t.layers.includes("barnwell_priory")||e.appData.layers.addLayer(g,{id:"barnwell_priory",text:"Barnwell Priory (historical)",color:"orange",visible:!1}),t.layers&&!t.layers.includes("overlays")||(e.appData.layers.addLayer(g,{id:"camantsoc_1836_1838",text:"Map circa 1836-1838",opacity:t.overlay_opacity,visible:!1}),e.appData.layers.addLayer(g,{id:"camantsoc_1910",text:"Map circa 1910",opacity:t.overlay_opacity,visible:!1}),e.appData.layers.addLayer(g,{id:"camantsoc_1925",text:"Map circa 1925",opacity:t.overlay_opacity,visible:!1})),e}window.raraMaps=e;