/*! Built from commit: 00c0fc224c0467e91d8d5d489be5f65a63e4b0bd */var t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{boundaryRadiusCreateMap:()=>b,heritageTrailCreateMap:()=>m,historyCreateMap:()=>_,vectorCreateMap:()=>D});class i{#t;constructor(t,e){this.#t=e,t.on("load",()=>{t.addSource("empty",{type:"geojson",data:{type:"FeatureCollection",features:[]}});for(let e=this.#t.length-1;e>=0;e--)t.addLayer({id:`z-${e}`,type:"symbol",source:"empty"},e===this.#t.length-1?void 0:`z-${e+1}`)})}getPosition(t){if(!this.#t.includes(t))throw new Error(`Layer ${t} not included as a sortable layer`);return`z-${this.#t.indexOf(t)}`}}class a{#e;#i;#a;#o;constructor(t,e,i,a){console.debug(`Layer.create id=${e} visible=${i}`),this.#e=e,this.#i=t,this.#a=i,this.#o=a}set visible(t){console.debug(`Layer.setVisible id=${this.#e} visible=${t}`),this.#a=t,this.#s()}get visible(){return this.#a}onLoaded(){console.debug(`Layer.onLoaded id=${this.#e} visible=${this.visible} callback=${this.#o}`),this.#s(),this.#o&&this.#o(this.#e)}toggleVisible(){return console.debug(`Layer.toggleVisible id=${this.#e} visible=${this.visible}`),this.visible="visible"!==this.#i.map.getLayoutProperty(this.#e,"visibility"),this.visible}#s(){console.debug(`Layer.onVisibleChange id=${this.#e} visible=${this.visible}`),this.#i.map.setLayoutProperty(this.#e,"visibility",this.visible?"visible":"none")}}class o{#r;#n;#l;#c;constructor(t){this.#r={},this.#n=t.map,this.#l=t.menu,this.#c=new i(t.map,t.zOrder)}get map(){return this.#n}getLayer(t){return this.#r[t]}get zOrder(){return this.#c}addLayer(t,e){e.visible=e.visible??!0;const i=this.#d(e.id,e.visible,e.callback);e.callback=t=>{i.onLoaded(t)},e.zOrder=this.#c,t(this.#n,e);(e.addToMenu??!0)&&this.#l.addItem({id:e.id,text:e.text,onclick:()=>i.toggleVisible(),active:e.visible,color:e.color})}#d(t,e,i){const o=new a(this,t,e,i);return this.#r[t]=o,o}}class s{#p;constructor(){if(this.#p=document.getElementById("menu"),this.#p){const t=t=>{"m"===t.key&&this.#u()};document.addEventListener("keydown",t,!0)}}addItem(t){if(this.#p){const e=document.createElement("a");e.id=`menu_${t.id}`,e.layerId=t.id,e.href="#",e.textContent=t.text,e.className=t.active?"active":"",e.onclick=i=>{i.preventDefault(),i.stopPropagation(),e.className=t.onclick()?"active":""};const i=document.createElement("div");i.className="box",i.style.backgroundColor=t.color??"transparent",e.appendChild(i),this.#p.appendChild(e),this.#h()}}#h(){this.#p.hidden=!1}#u(){console.debug("Menu.toggleVisible"),this.#p.hidden=!this.#p.hidden}}class r{#e;#b;#i;#g;#y;constructor(t,e){console.debug(`Location.create id=${e}`),this.#e=e,this.#b=null,this.#i=t,this.#g=null,this.#y=!1}get data(){return this.#b}get popupVisible(){return this.#y}set popupVisible(t){console.debug(`Location.setPopupVisible id=${this.#e} visible=${t}`),this.#y=t,this.#m()}setData(t){console.debug(`Location.setData id=${this.#e} data=${t}`),this.#b=t,this.#g=new maplibregl.Popup({closeButton:!1,closeOnClick:!1}),this.#g.setLngLat(t.geometry.coordinates).setHTML(t.properties.title).addTo(this.#i.map),this.#m()}#m(){console.debug(`Location.onPopupVisibleChange id=${this.#e} visible=${this.popupVisible} popup=${this.#g}`),this.#g&&(this.#g.getElement().style.visibility=this.popupVisible?"visible":"hidden")}}class n{#v;#n;constructor(t){this.#v={},this.#n=t.map}get map(){return this.#n}getLocation(t){return t in this.#v||this.#f(t),this.#v[t]}#f(t){console.debug("LocationManager.addLocation",t);const e=new r(this,t);return this.#v[t]=e,e}}function l(t){console.debug("Map",t);const e=new maplibregl.Map(t.config),i=new s,a=new o({map:e,menu:i,zOrder:t.zOrder??[]}),r=new n({map:e});return e.appData={layers:a,locations:r},function(t){t.addControl(new maplibregl.NavigationControl({visualizePitch:!0,visualizeRoll:!0,showZoom:!0,showCompass:!0})),t.addControl(new maplibregl.FullscreenControl),t.addControl(new maplibregl.ScaleControl,"bottom-right")}(e),e}function c(t,e){const i=e.id;t.on("load",()=>{const a=t.getStyle().layers;let o;for(let t=0;t<a.length;t++)if("symbol"===a[t].type&&"layout"in a[t]&&a[t].layout["text-field"]){o=a[t].id;break}t.addSource(i,{url:"https://tiles.openfreemap.org/planet",type:"vector"}),t.addLayer({id:i,source:i,"source-layer":"building",type:"fill-extrusion",minzoom:15,filter:["!=",["get","hide_3d"],!0],layout:{visibility:e.visible?"visible":"none"},paint:{"fill-extrusion-color":["interpolate",["linear"],["get","render_height"],0,"lightgray",200,"royalblue",400,"lightblue"],"fill-extrusion-height":["interpolate",["linear"],["zoom"],15,0,16,["get","render_height"]],"fill-extrusion-base":["case",[">=",["get","zoom"],16],["get","render_min_height"],0]}},o),e.callback&&e.callback(["buildings",i])})}function d(t,e){const i=e.id;t.on("load",()=>{fetch(e.url).then(t=>t.json()).then(a=>{t.addSource(i,{type:"geojson",data:a}),t.addLayer({id:i,type:"line",source:i,layout:{"line-join":"round","line-cap":"round",visibility:e.visible?"visible":"none"},paint:{"line-color":e.color,"line-width":6}},e.zOrder?e.zOrder.getPosition(i):null),e.callback&&e.callback(["line",i])})})}const p="%{RARA_MAPS}";function u(t){return t.startsWith(p)?raraMapsData.baseUrl+t.slice(p.length):t}function h(t,e){t.on("load",async()=>{const i=e.id,a=t.appData.locations,o=await t.loadImage(u(`%{RARA_MAPS}/lib/assets/icons/pin-${e.color}.png`));t.addImage(i,o.data),fetch(e.url).then(t=>t.json()).then(o=>{if(e.tags&&(o.features=o.features.filter(t=>e.tags.every(e=>t.properties.tags.includes(e)))),o.features.forEach(t=>{const i=a.getLocation(t.properties.id);i.setData(t),e.staticPopups&&(i.popupVisible=!0)}),t.addSource(i,{type:"geojson",data:o}),t.addLayer({id:i,type:"symbol",source:i,layout:{"icon-image":i,"icon-size":1,"icon-allow-overlap":!0,visibility:e.visible?"visible":"none"}},e.zOrder?e.zOrder.getPosition(i):null),!e.staticPopups){let o,s;t.on("mousemove",i,i=>{const r=i.features[0].geometry.coordinates.toString();if(s!==r){s=r,t.getCanvas().style.cursor="pointer";const n=i.features[0].geometry.coordinates.slice();for(;Math.abs(i.lngLat.lng-n[0])>180;)n[0]+=i.lngLat.lng>n[0]?360:-360;o&&(a.getLocation(o).popupVisible=!1),o=i.features[0].properties.id,a.getLocation(o).popupVisible=!0,e.onenter&&e.onenter(o)}}),t.on("mouseleave",i,()=>{const i=o;t.getCanvas().style.cursor="",a.getLocation(o).popupVisible=!1,o=void 0,s=void 0,e.onleave&&e.onleave(i)})}e.onclick&&t.on("click",i,t=>{e.onclick(t.features[0].properties.id)})})})}function b(){const t=new l({config:{style:u("%{RARA_MAPS}/app/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},zOrder:["boundary","heritage_trail","attractions","improvements"]});let e=null;let i=null;const a=new maplibregl.LngLat(.14547600132800653,52.212610097321885),o=turf.point([a.lng,a.lat]),s=()=>{e=e||Date.now();const r=(Date.now()-e)%3e4,n=turf.along(i,turf.lineDistance(i)*r/3e4).geometry.coordinates,l=turf.distance(o,n,{units:"meters"}),c=turf.bearing(o,n),d=l+500,p=turf.destination(o,d,c,{units:"meters"}).geometry.coordinates;t.jumpTo(t.calculateCameraOptionsFromTo(new maplibregl.LngLat(p[0],p[1]),300,a)),requestAnimationFrame(s)};return t.on("load",async()=>{fetch(u("%{RARA_MAPS}/app/assets/data/line_boundary_smooth.json")).then(t=>t.json()).then(t=>{const e=t.features[0].geometry.coordinates;i=turf.lineString(e),s()})}),t.appData.layers.addLayer(c,{id:"3d_buildings",text:"3D buildings",color:"#aaaaaa",visible:!0}),t.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/app/assets/data/line_boundary.json"),color:"black",visible:!0}),t.appData.layers.addLayer(d,{id:"heritage_trail",text:"Heritage trail line",url:u("%{RARA_MAPS}/app/assets/data/line_heritage_trail.json"),color:"green",visible:!1}),t.appData.layers.addLayer(h,{id:"attractions",text:"Attractions",url:u("%{RARA_MAPS}/app/assets/data/locations.json"),tags:["attractions"],color:"yellow",visible:!0,staticPopups:!0}),t.appData.layers.addLayer(h,{id:"improvements",text:"Improvements",url:u("%{RARA_MAPS}/app/assets/data/locations.json"),tags:["improvements"],color:"red",visible:!0,staticPopups:!0}),t}class g{#L;#A;#n;#_;#D;#C;#R;#S;#P;#M;#w;#k;constructor(t){this.#L={coord:null,altitude:t.altitude??500,distance:null},this.#A=t.distance??500,this.#n=t.map,this.#w=1e-4,this.#O(t.lineId,t.autoStart??!1)}#O(t,e){this.#n.getSource(t).getData().then(t=>{console.debug("Route loaded");const i=t.features[0].geometry.coordinates;this.#_=turf.lineString(i);const a=maplibregl.MercatorCoordinate.fromLngLat(i[0]),o=maplibregl.MercatorCoordinate.fromLngLat(turf.along(this.#_,turf.lineDistance(this.#_)/4).geometry.coordinates),s=o.x-a.x,r=o.y-a.y;this.#L.distance=this.#A??Math.hypot(s,r),this.#L.coord=new maplibregl.MercatorCoordinate(a.x-s,a.y-r),this.#n.jumpTo(this.#n.calculateCameraOptionsFromTo(this.#L.coord.toLngLat(),this.#L.altitude,i[0])),e&&(console.debug("Automatically starting"),this.#j())})}#j(){if(console.debug("Route.start"),this.#R=0,this.#P=null,this.#M=!1,this.#k=1,this.#C){console.debug("Start coordinates:",this.#C);const t=turf.point(this.#C),e=turf.nearestPointOnLine(this.#_,t);this.#R=e.properties.location,console.debug("Start distance (km):",this.#R)}if(this.#S){console.debug("Stop coordinates:",this.#S);const t=turf.point(this.#S),e=turf.nearestPointOnLine(this.#_,t);this.#P=e.properties.location,console.debug("Stop distance (km):",this.#P)}this.#P&&this.#P<this.#R&&(this.#k=-1),this.#D=Date.now(),this.#x()}#x(){if(this.#M)return;const t=Date.now()-this.#D;let e=this.#R+t*this.#w*this.#k;if(!this.#P){e%=turf.lineDistance(this.#_)}const i=turf.along(this.#_,e).geometry.coordinates;this.#n.getSource("point").setData({type:"Point",coordinates:i});const a=maplibregl.MercatorCoordinate.fromLngLat(i),o=a.x-this.#L.coord.x,s=a.y-this.#L.coord.y,r=Math.hypot(o,s)-this.#L.distance;if(r>0){const t=Math.atan2(s,o);this.#L.coord.x+=Math.cos(t)*r,this.#L.coord.y+=Math.sin(t)*r}if(this.#n.jumpTo(this.#n.calculateCameraOptionsFromTo(this.#L.coord.toLngLat(),this.#L.altitude,i)),null!==this.#P&&(this.#k>0&&e>=this.#P||this.#k<0&&e<=this.#P))return this.#M=!0,void console.debug("Stopped at distance:",this.#P);requestAnimationFrame(()=>{this.#x()})}fly(t,e){console.debug("Fly from",t,"to",e),this.#C=t,this.#S=e,this.#M=!1,this.#_&&this.#j()}}let y=null;function m(t){t=t??{};const e=new l({config:{style:u("%{RARA_MAPS}/app/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},zOrder:["boundary","heritage_trail","locations","point"]});e.on("load",()=>{e.addSource("point",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"Point",coordinates:[0,0]}}}),e.addLayer({id:"point",source:"point",type:"circle",paint:{"circle-radius":10,"circle-color":"#ff0000","circle-stroke-width":2,"circle-stroke-color":"white"}},e.appData.layers.zOrder.getPosition("point"))}),e.appData.layers.addLayer(c,{id:"3d_buildings",text:"3D buildings",color:"#aaaaaa",visible:!0}),e.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/app/assets/data/line_boundary.json"),color:"black",visible:!1}),e.appData.layers.addLayer(d,{id:"heritage_trail",text:"Heritage trail line",url:u("%{RARA_MAPS}/app/assets/data/line_heritage_trail.json"),color:"green",callback:({})=>{y=new g({altitude:200,distance:500,lineId:"heritage_trail",map:e})},visible:!0}),e.appData.layers.addLayer(h,{id:"locations",text:"Heritage trail locations",url:u("%{RARA_MAPS}/app/assets/data/locations.json"),tags:["attractions"],color:"green",onclick:t.locationOnClick??null,visible:!0});const i=e.appData.locations;return e.appData.fly=function(t,e){if(console.debug(`Fly from ${t} to ${e}`),t!==e){const a=i.getLocation(t).data.geometry.coordinates,o=i.getLocation(e).data.geometry.coordinates;console.debug(`Fly from ${t} ${a} to ${e} ${o}`),y&&y.fly(a,o,2e3)}},e}const v=[];let f=null;const L="bottom-left";function A(t,e){t.addSource(e.id,{type:"image",url:e.url,coordinates:e.coordinates}),t.addLayer({id:e.id,type:"raster",source:e.id,paint:{"raster-opacity":e.opacity??1},layout:{visibility:e.visible?"visible":"none"}},e.zOrder?e.zOrder.getPosition(e.id):null),e.attribution&&function(t,e){v.includes(e)||v.push(e),f&&t.removeControl(f),f=new maplibregl.AttributionControl({compact:!0,customAttribution:`<br>${v.join("<br>")}`}),t.addControl(f,L);const i=document.getElementsByClassName(`maplibregl-ctrl-${L}`)[0].getElementsByTagName("details")[0];i.classList.remove("maplibregl-compact-show"),i.removeAttribute("open")}(t,e.attribution),e.callback&&e.callback(["overlay",e.id])}function _(){const t={style:u("%{RARA_MAPS}/app/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},e=["camantsoc_1836_1838","camantsoc_1910","camantsoc_1925","boundary"],i=new l({config:t,zOrder:e});return i.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/app/assets/data/line_boundary.json"),color:"black",visible:!0}),i.on("load",async()=>{fetch(u("%{RARA_MAPS}/app/assets/data/overlays.json")).then(t=>t.json()).then(t=>{for(const a of t.overlays.features)console.log(a.properties.id,a.properties.id in e),e.includes(a.properties.id)&&i.appData.layers.addLayer(A,{id:a.properties.id,text:a.properties.description[0],url:u(a.properties.url),coordinates:a.geometry.coordinates,attribution:a.properties.attribution?t.attributions[a.properties.attribution]:null,opacity:1,visible:!1,addToMenu:!1})})}),i}function D(t){t=t??{overlay_opacity:1};const e={style:u("%{RARA_MAPS}/app/assets/data/style.json"),center:[.144843,52.212231],zoom:15,container:"map",attributionControl:!1},i=["camantsoc_1836_1838","camantsoc_1910","camantsoc_1925","barnwell_priory","boundary","heritage_trail","attractions","improvements"],a=new l({config:e,zOrder:i});return t.layers&&!t.layers.includes("3d_buildings")||a.appData.layers.addLayer(c,{id:"3d_buildings",text:"3D buildings",color:"#aaaaaa",visible:!1}),t.layers&&!t.layers.includes("boundary")||a.appData.layers.addLayer(d,{id:"boundary",text:"Riverside area boundary",url:u("%{RARA_MAPS}/app/assets/data/line_boundary.json"),color:"black",visible:!0}),t.layers&&!t.layers.includes("heritage_trail")||a.appData.layers.addLayer(d,{id:"heritage_trail",text:"Heritage trail line",url:u("%{RARA_MAPS}/app/assets/data/line_heritage_trail.json"),color:"green",visible:!1}),t.layers&&!t.layers.includes("attractions")||a.appData.layers.addLayer(h,{id:"attractions",text:"Attractions",url:u("%{RARA_MAPS}/app/assets/data/locations.json"),tags:["attractions"],color:"yellow",onclick:t.locationOnClick??null,onenter:t.locationOnEnter??null,onleave:t.locationOnLeave??null,visible:t.locationVisible??!1}),t.layers&&!t.layers.includes("improvements")||a.appData.layers.addLayer(h,{id:"improvements",text:"Improvements",url:u("%{RARA_MAPS}/app/assets/data/locations.json"),tags:["improvements"],color:"red",onclick:t.locationOnClick??null,onenter:t.locationOnEnter??null,onleave:t.locationOnLeave??null,visible:t.locationVisible??!1}),a.on("load",async()=>{fetch(u("%{RARA_MAPS}/app/assets/data/overlays.json")).then(t=>t.json()).then(e=>{for(const o of e.overlays.features)console.log(o.properties.id,o.properties.id in i),i.includes(o.properties.id)&&(t.layers&&!t.layers.includes(o.properties.id)||a.appData.layers.addLayer(A,{id:o.properties.id,text:o.properties.description[0],url:u(o.properties.url),coordinates:o.geometry.coordinates,attribution:o.properties.attribution?e.attributions[o.properties.attribution]:null,opacity:1,visible:!1}))})}),a}window.raraMaps=e;